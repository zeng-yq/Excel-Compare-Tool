# 项目概述
本项目（Excel Compare）是一个基于 Web 的纯前端 Excel 内容对比应用。它模拟 vimdiff 的双栏分屏界面，允许用户上传两个 Excel 文件，支持独立 Sheet 切换。系统通过 Myers 差分算法计算差异，并提供**智能折叠功能**（默认隐藏连续的相同行），聚焦核心差异，支持双向同步滚动查看。
# 用户交互流程
1. **初始化**: 界面展示顶部 Header 和中间左右两个大的虚线文件上传区。
2. **文件加载**:
    - 用户拖拽 File A 到左侧 -> 左侧变为表格视图（显示原始数据，无高亮），左侧表格视图顶部出现 Sheet 下拉框。
    - 用户拖拽 File B 到右侧 -> 右侧变为表格视图（显示原始数据，无高亮），右侧表格视图顶部出现 Sheet 下拉框。
3. **调整设置**:
    - **Sheet 切换**: 用户可在左右两侧独立切换 Sheet，切换后，该侧表格立即更新为新 Sheet 的原始数据。
    - **视图高度**: 在顶部菜单选择 15/30/50 行，调整可视区域高度。
    - **折叠选项**: 用户可勾选或取消顶部菜单的“显示所有相同行”（默认不勾选）。
4. **触发对比**:
    - 左右均有数据时，点击顶部“开始对比”按钮。
    - 系统执行 Diff 算法 -> 对齐数据 -> **执行折叠逻辑**。
    - 表格视图更新：显示高亮差异，连续的相同行被折叠条取代。
5. **查看与修正**:
    - 滚动查看，左右两侧表格同步滚动。
    - 点击“折叠条”可展开特定区域；或并在顶部开启“显示所有”全局展开。
# 详细功能设计
## 布局与文件区域
### **整体布局**:
- **Header**: Logo（SVG 图标）、网站名称（Excel Compare）。
- **Main**:上面部分为配置栏（显示所有相同行的开关、视图高度选择器、开始对比按钮）；下面部分为双栏布局。
```text
Header
ConfigBar（折叠开关、视高选择、对比按钮）
-----------------------------------------
|                |                      |
|   Left Panel   |   Right Panel        |
|                |                      |
-----------------------------------------
```
### **上传交互**:
- 支持拖拽上传和点击上传。
- 上传后，该文件上传区域直接替换为“数据预览面板”。
- 支持文件替换功能，面板左上角提供“重新上传”按钮。
##  独立 Sheet 管理
- **位置**: 在每个数据面板（左/右）内部的左上角。
- **逻辑**:
    - 解析 Excel Workbook 对象，获取所有 SheetName，默认选中第一个 Sheet。
    - **交互**:
        - 左侧切换 Sheet，仅刷新左侧表格内容。
        - 右侧切换 Sheet，仅刷新右侧表格内容。
        - **关键状态变更**: 只要任意一侧切换了 Sheet，必须**清除当前的 Diff 结果**，回退到“原始数据预览”状态（原始表格数据，无高亮，无折叠）。
## 核心对比与折叠逻辑
- **触发时机**: 点击“开始对比”按钮后。
- **处理流程**:
    1. **预处理**: 转 String，Trim 去空格。
    2. **Diff 计算**: 使用 Myers 算法计算 Added/Removed。
    3. **行对齐**: 插入 EMPTY 占位行。
    4. **块内修正**: 将相邻的“左删右增”合并为“MODIFIED”，计算单元格差异。
    5. **智能折叠**:
        - **前置判断**: 检查“显示所有相同行”开关。若开启，跳过此步。
        - **上下文保留**: 默认保留差异行 **上下各 3 行** 的相同数据作为上下文 (Context)。
        - **折叠判断**: 遍历对齐后的列表，若连续的 SAME 行数 > (3 + 3)，则将中间部分替换为 FOLD_BAR (折叠条对象)。
- **块内优化**: 将相邻的“左删右增”合并为“修改”，并进行单元格级 Diff。
- **加载状态**: 点击按钮后显示 Loading Spinner，防止页面假死。
##  视觉样式与行号规范
### A. 行号处理
- **原则**: 忠实反映原始 Excel 文件中的行号。
- **左侧表格**:
    - **原有数据行**: 显示该行在左侧文件中的原始行号 (1, 2, 3...)。
    - **插入的占位行 (Empty)**: **不显示行号** (留白)。
- **右侧表格**:
    - **原有数据行**: 显示该行在右侧文件中的原始行号。
    - **插入的占位行 (Empty)**: **不显示行号**。
- **折叠条**: 不显示行号。
### B. 空行填充样式
- **样式**: **浅灰色斜线纹理** (Light Gray Hashed Pattern)。
- **CSS 实现参考**: 使用 repeating-linear-gradient 实现 45度斜纹，背景色微灰，视觉上表示“此处无内容且是为了对齐而存在”。
### C. 折叠条样式
- **外观**: 跨越整行（左右各一条）的浅色横条。
- **内容**: 居中显示文本，例如 “... 展开 158 行相同内容 ...”。
- **交互**: 点击折叠条可展开该段内容。
## 视图高度控制
- **逻辑**: 设置滚动容器 CSS 的 height (非分页)。
- **预设档位**:
    - 15 行 (默认)
    - 30 行
    - 50 行
- **计算**:（估算） height = (行数 * 32px) + 表头高度。
- **实现逻辑**:
    - 假设单行高度固定为 32px (Tailwind h-8)，表头高度 40px。
    - **15 行**: 容器高度 ≈ 32 * 15 + 40 px。
    - **30 行**: 容器高度 ≈ 32 * 30 + 40 px。
    - **50 行**: 容器高度 ≈ 32 * 50 + 40 px。
    - **默认值**: 默认为 15 行
- **表现**: 内容超出设定高度时，容器内部出现垂直滚动条。
## 同步滚动
- **机制**: 监听 onScroll 事件。
- **垂直同步**: 即使存在折叠，左右两侧的**渲染高度** (Render Height) 始终保持一致（因为折叠也是左右同步进行的）。左侧滚到 50%，右侧强制同步到 50%。
- **水平同步**: 左侧水平滚动时，右侧跟随。
- **性能**: 使用原生滚动条。
# 技术栈
- 前端框架：Next.js 
- UI：Tailwind CSS + shadcn/ui
- 解析 Excel：SheetJS
- Diff 算法：使用 Myers 算法
## Web Worker 集成
为了不阻塞 UI：
1. 用户点击“开始对比”。
2. UI 显示 Loading Spinner。
3. 主线程发送 postMessage 给 Worker，包含两个 Sheet 的 JSON 数据。
4. Worker 跑 Diff 算法、对齐逻辑、生成初步的 RowDiff 数组。
5. Worker 返回结果。
6. UI 接收结果，关闭 Loading，渲染 DiffTable。
